{% extends 'base.html' %}
{% block title %}Add Result - Result Management System{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1><i class="fas fa-plus-circle"></i> Add New Result</h1>
    </div>

    <div class="card">
        <form method="POST" class="form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

            <!-- Filters -->
            <div class="form-row"
                style="background-color: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                <div class="form-group">
                    <label for="filter_faculty"><i class="fas fa-filter"></i> Filter by Faculty</label>
                    <select id="filter_faculty" onchange="filterOptions()">
                        <option value="">All Faculties</option>
                        {% for faculty in faculties %}
                        <option value="{{ faculty.id }}">{{ faculty.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="filter_department"><i class="fas fa-filter"></i> Filter by Department</label>
                    <select id="filter_department" onchange="filterOptions()">
                        <option value="">All Departments</option>
                        {% for dept in departments %}
                        <option value="{{ dept.id }}" data-faculty="{{ dept.faculty_id }}">{{ dept.dept_name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="student_id">Student *</label>
                    <select id="student_id" name="student_id" required>
                        <option value="">Select Student</option>
                        {% for student in students %}
                        <option value="{{ student.student_id }}" data-faculty="{{ student.faculty_id }}"
                            data-dept="{{ student.dept_id }}">
                            {{ student.student_id }} - {{ student.name }} ({{ student.dept_name if student.dept_name
                            else 'No Dept' }})
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="subject_code">Subject *</label>
                    <select id="subject_code" name="subject_code" required>
                        <option value="">Select Subject</option>
                        {% for subject in subjects %}
                        <option value="{{ subject.subject_code }}" data-faculty="{{ subject.faculty_id }}"
                            data-dept="{{ subject.dept_id }}">
                            {{ subject.subject_name }} ({{ subject.dept_name if subject.dept_name else 'No Dept' }})
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="marks">Marks Obtained *</label>
                    <input type="number" id="marks" name="marks" required min="0" max="100" step="0.01"
                        placeholder="e.g., 85.5">
                </div>
                <div class="form-group">
                    <label for="semester">Semester *</label>
                    <select id="semester" name="semester" required>
                        <option value="first semester">first semester</option>
                        <option value="second semester">second semester</option>
                        <option value="summer">summer</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label for="academic_year">Academic Year (Session) *</label>
                <select id="academic_year" name="academic_year" required>
                    <option value="">Select Session</option>
                    {% for year in range(2026, 1999, -1) %}
                    {% set session = year ~ "/" ~ (year + 1) %}
                    <option value="{{ session }}" {% if session=='2024/2025' %}selected{% endif %}>{{ session }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Add Result
                </button>
                <a href="{{ url_for('results') }}" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Cancel
                </a>
            </div>
        </form>
    </div>
</div>

<script>
    function filterOptions() {
        const facultyId = document.getElementById('filter_faculty').value;
        const deptId = document.getElementById('filter_department').value;

        // Filter Departments based on Faculty
        const deptSelect = document.getElementById('filter_department');
        const deptOptions = deptSelect.querySelectorAll('option[data-faculty]');

        deptOptions.forEach(opt => {
            if (facultyId && opt.dataset.faculty !== facultyId) {
                opt.style.display = 'none';
            } else {
                opt.style.display = '';
            }
        });

        // Filter Students
        const studentSelect = document.getElementById('student_id');
        const studentOptions = studentSelect.querySelectorAll('option[data-faculty]');

        studentOptions.forEach(opt => {
            let show = true;
            if (facultyId && opt.dataset.faculty != facultyId) show = false;
            // If department is selected differently from filter (or filter is empty), check dept
            // But if filter_department is selected, we enforce it.
            // Note: If faculty is selected, dept filter should be cleared or filtered? 
            // Let's keep it simple: MATCH IF SET
            if (deptId && opt.dataset.dept != deptId) show = false;

            opt.style.display = show ? '' : 'none';
        });

        // Filter Subjects
        const subjectSelect = document.getElementById('subject_code');
        const subjectOptions = subjectSelect.querySelectorAll('option[data-faculty]');

        subjectOptions.forEach(opt => {
            let show = true;
            if (facultyId && opt.dataset.faculty != facultyId) show = false;
            if (deptId && opt.dataset.dept != deptId) show = false;

            opt.style.display = show ? '' : 'none';
        });

        // Reset selections if hidden
        // Optional: clear value if selected option is now hidden
    }
</script>
{% endblock %}